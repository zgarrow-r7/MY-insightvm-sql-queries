with 
	owner as
  (
select
	dt.name
from
	dim_tag dt
join dim_asset_tag dat on
	dt.tag_id = dat.tag_id
where
	dt.type = 'OWNER'
        ),
    custom as
  (
select
	dt.name
from
	dim_tag dt
join dim_asset_tag dat on
	dt.tag_id = dat.tag_id
where
	dt.type = 'CUSTOM'
        ),
	cert as
  (
select
	daos.asset_id,
	max(daos.certainty) as certainty
from
	dim_asset_operating_system daos
where
	(exists
            (
	select
		1
	from
		dim_asset da_1
	where
		daos.asset_id = da_1.asset_id))
group by
	daos.asset_id),
     solution as
  (
select
	davfs.asset_id,
	davfs.vulnerability_id,
	string_agg(ds.summary,
	' | '::text
order by
	ds.solution_id) as "Solution Summary",
	string_agg(htmltotext(ds.fix),
	' | '::text
order by
	ds.solution_id) as "Solution"
from
	dim_asset_vulnerability_finding_solution davfs
join dim_solution ds on
	davfs.solution_id = ds.solution_id
join fact_asset_vulnerability_finding f_1 on
	f_1.asset_id = davfs.asset_id
	and f_1.vulnerability_id = davfs.vulnerability_id
group by
	ds.summary,
	davfs.asset_id,
	davfs.vulnerability_id)
select 
	distinct on
	(dv.vulnerability_id,
	da.ip_address,
	da.host_name) da.host_name as "Host Name",
	da.asset_id,
	dv.vulnerability_id,
	da.ip_address as "IP Address",
	dv.severity as "Vulnerability Severity Level",
	dv.title as "Vulnerability Title",
	htmlToText(dv.description) as "Vulnerability Description",
	f.date as "Vulnerability Finding Date",
	date_part('day'::text,
	'now'::text::date::timestamp without time zone - f.date) as "Vulnerability Age",
	solution as "Solution",
	htmlToText(favi.proof) as "Vulnerability Proof",
	da.last_assessed_for_vulnerabilities as "Last Date Found",
	da.os_family as "Asset OS Family",
	da.os_name as "Asset OS Name",
	da.sites as "Site",
	das.port as "Service Port",
	das.protocol as "Service Protocol",
	substring(dv.nexpose_id
from
	'cve-[0-9]+-[0-9]+') as "CVE ID",
	dv.date_published as "Vulnerability Published Date",
	dv.risk_score as "Vulnerability Risk Score",
	dv.cvss_v3_score as "Vulnerability CVSSv3 Score",
	dv.cvss_v3_vector as "Vulnerability CVSSv3 Vector",
	owner as "Asset Owner",
	custom as "Custom Tag",
	fa.risk_score as "Asset Risk Score",
	dv.exploits as "Exploit Count",
	dv.malware_kits as "Malware Kit Count",
	dv.cvss_score as "Vulnerability CVSS Score",
	dv.cvss_vector as "Vulnerability CVSS Vector"
from
	fact_asset_vulnerability_finding f
join dim_asset da on
	f.asset_id = da.asset_id
join fact_asset_vulnerability_instance favi on
	da.asset_id = favi.asset_id
join fact_asset fa on
	favi.asset_id = fa.asset_id
left join dim_asset_service das on
	fa.asset_id = das.asset_id
join dim_asset_tag dat on
	fa.asset_id = dat.asset_id
left join dim_tag dt on
	dat.tag_id = dt.tag_id
join dim_vulnerability dv on
	f.vulnerability_id = dv.vulnerability_id
left join solution on
	f.asset_id = solution.asset_id
	and f.vulnerability_id = solution.vulnerability_id
left join cert on
	f.asset_id = cert.asset_id
left join owner on
	dt.name = owner.name
left join custom on
	dt.name = custom.name
