WITH 
	owner as
  (SELECT
        dt.name
    FROM
        dim_tag dt
        JOIN dim_asset_tag dat ON dt.tag_id = dat.tag_id
    WHERE
        dt.type = 'OWNER'
        ),
    custom as
  (SELECT
        dt.name
    FROM
        dim_tag dt
        JOIN dim_asset_tag dat ON dt.tag_id = dat.tag_id
    WHERE
        dt.type = 'CUSTOM'
        ),
	cert AS
  (SELECT daos.asset_id,
          max(daos.certainty) AS certainty
   FROM dim_asset_operating_system daos
   WHERE (EXISTS
            (SELECT 1
             FROM dim_asset da_1
             WHERE daos.asset_id = da_1.asset_id))
   GROUP BY daos.asset_id),
     solution AS
  (SELECT davfs.asset_id,
          davfs.vulnerability_id,
          string_agg(ds.summary, ' | '::text
                     ORDER BY ds.solution_id) AS "Solution Summary",
          string_agg(htmltotext(ds.fix), ' | '::text
                     ORDER BY ds.solution_id) AS "Solution"
   FROM dim_asset_vulnerability_finding_solution davfs
   JOIN dim_solution ds ON davfs.solution_id = ds.solution_id
   JOIN fact_asset_vulnerability_finding f_1 ON f_1.asset_id = davfs.asset_id
   AND f_1.vulnerability_id = davfs.vulnerability_id
   GROUP BY ds.summary,
   			davfs.asset_id,
            davfs.vulnerability_id)
SELECT 
	DISTINCT ON (dv.vulnerability_id, da.ip_address, da.host_name) da.host_name AS "Host Name",
	da.asset_id,
	dv.vulnerability_id,
	da.ip_address AS "IP Address",
	dv.severity as "Vulnerability Severity Level",
	dv.title as "Vulnerability Title",
	htmlToText(dv.description) as "Vulnerability Description",
	f.date as "Vulnerability Finding Date",
	date_part('day'::text, 'now'::text::date::timestamp without time zone - f.date) AS "Vulnerability Age",
	solution as "Solution",
	htmlToText(favi.proof) as "Vulnerability Proof",
	da.last_assessed_for_vulnerabilities AS "Last Date Found",
	da.os_family as "Asset OS Family",
	da.os_name as "Asset OS Name",
	da.sites AS "Site",
	das.port AS "Service Port",
	das.protocol as "Service Protocol",
	substring(dv.nexpose_id from 'cve-[0-9]+-[0-9]+') as "CVE ID",
	dv.date_published as "Vulnerability Published Date",
	dv.risk_score as "Vulnerability Risk Score",
	dv.cvss_v3_score as "Vulnerability CVSSv3 Score",
	dv.cvss_v3_vector as "Vulnerability CVSSv3 Vector",
	owner AS "Asset Owner",
	custom as "Custom Tag",
	fa.risk_score as "Asset Risk Score",
	dv.exploits as "Exploit Count",
	dv.malware_kits as "Malware Kit Count",
	dv.cvss_score as "Vulnerability CVSS Score",
	dv.cvss_vector as "Vulnerability CVSS Vector"
FROM fact_asset_vulnerability_finding f
JOIN dim_asset da ON f.asset_id = da.asset_id
join fact_asset_vulnerability_instance favi on da.asset_id = favi.asset_id
join fact_asset fa on favi.asset_id = fa.asset_id
left join dim_asset_service das on fa.asset_id = das.asset_id
join dim_asset_tag dat on fa.asset_id = dat.asset_id
left join dim_tag dt on dat.tag_id = dt.tag_id
JOIN dim_vulnerability dv ON f.vulnerability_id = dv.vulnerability_id
LEFT JOIN solution ON f.asset_id = solution.asset_id
AND f.vulnerability_id = solution.vulnerability_id
LEFT JOIN cert ON f.asset_id = cert.asset_id
left join owner on dt.name = owner.name
left join custom on dt.name = custom.name
